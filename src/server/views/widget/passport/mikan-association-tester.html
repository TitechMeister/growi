<form id="formTestMikanCredentials" method="post" class="form-horizontal" role="form">
  <div class="alert-container"></div>
  <fieldset>
    <div class="form-group">
      <label for="username" class="col-xs-3 control-label">{{ t('Username') }}</label>
      <div class="col-xs-6">
        <input class="form-control" name="loginForm[username]">
        <p class="help-block">
          <small>
            Username must be the one currently logged in with mikan.
          </small>
        </p>
      </div>
    </div>
    <div class="form-group">
      <button type="button" class="btn btn-default col-xs-offset-5 col-xs-2" onclick="testMikanCredentials()">{{ t('Test') }}</button>
    </div>
  </fieldset>
  <script>
    /**
    * test association (ajax)
     */
    function testMikanCredentials() {
      function showMessage(formId, msg, status) {
        $('#' + formId + ' .alert-container .alert').remove();
        var $message = $('<p class="alert"></p>');
        $message.addClass('alert-' + status);
        $message.html(msg.replace('\n', '<br>'));
        $message.appendTo('#' + formId + '> .alert-container');
        if (status == 'success') {
          setTimeout(function()
            {
              $message.fadeOut({
                complete: function() {
                  $message.remove();
                }
              });
            }, 5000);
        }
      }
      var $form = $('#formTestMikanCredentials');
      var $action = '/_api/login/testMikan';
      var $id = $form.attr('id');
      var $button = $('button', this);
      $button.attr('disabled', 'disabled');
      var jqxhr = $.post($action, $form.serialize(), function(data)
        {
          if (!data.status) {
            showMessage($id, 'data.status not found', 'danger');
          }
          else {
            showMessage($id, data.message, data.status);
          }
        })
        .fail(function() {
          showMessage($id, 'エラーが発生しました', 'danger');
        })
        .always(function() {
          $button.prop('disabled', false);
        });
      return false;
    }
  </script>
</form>
